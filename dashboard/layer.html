<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vox @ Twitch.tv</title>
</head>

<body>
<script>
    let openedSocket = null

    function connect() {
        // PROD: const ws = new WebSocket('ws://voxtwitch.monique.dev/ws/{{.UserID}}')
        const ws = new WebSocket(document.location.origin.replace('http','ws')+'/ws/{{.UserID}}')
        return new Promise((resolve, reject) => {
            // console.log("client try to connect...")

            ws.onopen = () => {
                // console.log("WEBSOCKET_OPENED: client connected to server at port 7001")
                openedSocket = true
                resolve(openedSocket)
            }

            ws.onmessage = (e) => {
                if (typeof e.data == "string") {
                    try {
                        // TODO: enfileirar mensagens recebidas ao inves de processar na hora
                        (new Audio(e.data)).play()
                    } catch (ex) {
                        console.log("ex:", ex)
                    }
                }
            }

            ws.onclose = (err) => {
                // console.log("WEBSOCKET_CLOSE: connection closed %o", err)
                openedSocket = false
                reject(err)
            }

            ws.onerror = (err) => {
                // console.log("WEBSOCKET_ERROR: ", err)
                openedSocket = false
                reject(err)
            }
        })
    }

    async function reconnect() {
        try {
            await connect()
        } catch (err) {
            // console.log("WEBSOCKET_RECONNECT: Error", new Error(err.message))
        }
    }

    reconnect();

    // repeat every 5 seconds
    setInterval(() => {
        if (openedSocket === false) {
            reconnect()
        }
    }, 5000);
</script>
</body>

</html>
