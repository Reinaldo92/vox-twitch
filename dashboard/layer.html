<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Vox @ Twitch.tv</title>
</head>

<body>
<script>
    let openedSocket = false
    const serverURL = document.location.origin.replace('http', 'ws')
    const wsPath = '/ws/{{ .UserID }}'

    function connect() {
        if (openedSocket) return

        const ws = new WebSocket(serverURL + wsPath)
        return new Promise((resolve, reject) => {
            ws.onopen = () => {
                openedSocket = true
                resolve(openedSocket)
            }
            ws.onclose = (err) => {
                openedSocket = false
                reject(err)
            }
            ws.onerror = (err) => {
                openedSocket = false
                reject(err)
            }

            ws.onmessage = (e) => {
                if (typeof e.data == "string") {
                    // client_id
                    // audio_url
                    // text
                    // username
                    const j = JSON.parse(e.data)
                    try {
                        // TODO: enfileirar mensagens recebidas ao inves de processar na hora
                        (new Audio(j["audio_url"])).play()
                    } catch (ex) {
                        // console.log("ex:", ex)
                    }
                }
            }

        })
    }

    async function reconnect() {
        try {
            await connect()
        } catch (err) {
        }
    }

    reconnect();
    setInterval(reconnect, 5000);
</script>
</body>

</html>
